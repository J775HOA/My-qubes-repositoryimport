#!/bin/bash -e

if [ "$1" == "on" ] ; then
    /sbin/ip route add table 78 blackhole default metric 1000
    /sbin/ip rule add fwmark 0x78 table 78
    /sbin/iptables -t mangle -A PREROUTING -j MARK --set-mark 0x78 -i vif+
    /sbin/iptables -t nat -L QUBES-VPN >& /dev/null || {
        /sbin/iptables -t nat -N QUBES-VPN
    }
    /sbin/iptables-save | grep -q -- '-j QUBES-VPN' || {
        /sbin/iptables -t nat -I PREROUTING 1 -m mark --mark 0x78 -j QUBES-VPN
    }
elif [ "$1" == "off" ] ; then
    /sbin/iptables -t mangle -F PREROUTING
    /sbin/ip rule del fwmark 0x78
    /sbin/ip route flush table 78
elif [ "$1" == "blackhole" ] ; then
    while true ; do
      if [ "$( /sbin/ip route list table 78 | head -1 | grep -v ^blackhole || true )" == "" ] ; then
        break
      fi
      /sbin/ip route del table 78 $( /sbin/ip route list table 78 | head -1 | grep -v ^blackhole || true )
    done
elif [ "$1" == "setuprouting" ] ; then
    subnet=$2
    gateway=$3
    device=$4
    /sbin/ip route replace table 78 to "$subnet" dev "$device"
    /sbin/ip route replace table 78 to default via "$gateway" dev "$device"
    /sbin/ip route del to "$subnet" dev "$device"
    /sbin/sysctl -w net.ipv4.conf."$device".rp_filter=2
fi
